{% extends "master/masterbase.html" %}
{% block head %}
<title>{{ clique.name }} Markers</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
{% endblock %}

{% block content %}
<style>
  html, body {
    height: 100%;
    margin: 0;
  }

  #map-wrapper {
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    padding-bottom: 80px;
  }

  #map {
    width: 90vw;
    height: 80vh;
    border: 2px solid #ccc;
    border-radius: 12px;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
  }

  h2 {
    text-align: center;
    margin-top: 20px;
  }
</style>

<h2>Markers for Clique: <strong>{{ clique.name }}</strong></h2>
<div id="map-wrapper">
  <div id="map"></div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script>
  const map = L.map('map').setView([31.0461, 34.8516], 8);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);

  fetch(`/clique-geojson/{{ clique.id }}`)
    .then(response => response.json())
    .then(data => {
      const layer = L.geoJSON(data, {
        pointToLayer: function (feature, latlng) {
          const props = feature.properties;
          const title = props.marker_title;
          const avg = props.average_review;
          const total = props.total_reviews;
          const reviews = props.reviews;
          const events = props.events;

          let popupContent = `<strong>${title}</strong>`;
          popupContent += `<br><span style="color: gold;">★ ${avg.toFixed(2)} (${total} review${total !== 1 ? 's' : ''})</span>`;

          if (reviews.length) {
            popupContent += `<hr><div><strong>Reviews:</strong></div>`;
            reviews.forEach(r => {
              popupContent += `<div style="margin-top: 4px;"><strong>${r.user}</strong>: <span style="color: gold;">${'★'.repeat(r.stars)}</span>`;
              if (r.commentary) popupContent += `<br><em>${r.commentary}</em>`;
              popupContent += `</div>`;
            });
          }

          if (events.length) {
            popupContent += `<hr><div><strong>Events:</strong></div>`;
            events.forEach(e => {
              popupContent += `<div style="margin-top: 4px;"><strong>${e.user}</strong>: ${e.description} (${e.date} ${e.time})</div>`;
            });
          }

          return L.marker(latlng).bindPopup(popupContent);
        }
      }).addTo(map);

      if (data.length > 0) {
        map.fitBounds(layer.getBounds());
      }
    })
    .catch(error => console.error("Error loading clique markers:", error));
</script>
{% endblock %}